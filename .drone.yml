---
kind: pipeline
name: default

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
  - name: ecs
    host:
      path: /etc/profile.d/ecs-credentials-endpoint
  - name: mix
    temp: {}

clone:
  depth: 1

steps:
  - name: cache-restore
    image: prima/drone-tools:1.15.0
    volumes:
      - name: ecs
        path: /etc/profile.d/ecs-credentials-endpoint
      - name: docker
        path: /var/run/docker.sock
    commands:
      - . /etc/profile.d/ecs-credentials-endpoint
      - cache-restore

  - name: init
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
      - name: docker
        path: /var/run/docker.sock
    environment:
      MIX_ENV: test    
    commands:
      - mix local.rebar --force
      - mix local.hex --force
      - mix deps.get
    depends_on:
      - cache-restore

  - name: compile-test
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
    environment:
      MIX_ENV: test
    commands:
      - mix compile --all-warnings --warnings-as-errors --ignore-module-conflict --debug-info
    depends_on:
      - init

  - name: format
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
    environment:
      MIX_ENV: test
    commands:
      - mix format --check-formatted mix.exs "lib/**/*.{ex,exs}" "test/**/*.{ex,exs}" "config/**/*.{ex,exs}"
    depends_on:
      - compile-test

  - name: credo
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
    environment:
      MIX_ENV: test
    commands:
      - mix credo -a
    depends_on:
      - compile-test

  - name: test
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
    environment:
      MIX_ENV: test
    commands:
      - mix test
    depends_on:
      - compile-test

  - name: dialyzer
    image: elixir:1.7
    volumes:
      - name: mix
        path: /root/.mix
    environment:
      MIX_ENV: test
    commands:
      - mix dialyzer --format dialyzer
    depends_on:
      - compile-test

  - name: cache-save
    image: prima/drone-tools:1.15.0
    volumes:
      - name: ecs
        path: /etc/profile.d/ecs-credentials-endpoint
      - name: docker
        path: /var/run/docker.sock
      - name: mix
        path: /root/.mix
    commands:
      - . /etc/profile.d/ecs-credentials-endpoint
      - cache-save _build deps
    depends_on:
      - dialyzer
      - test
      - credo
      - format
    when:
      branch:
        - master